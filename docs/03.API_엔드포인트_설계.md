# API 엔드포인트 설계서

## 개요

포트폴리오 매니저 MVP를 위한 RESTful API 엔드포인트 설계입니다.
ERD 설계서의 7개 핵심 엔티티를 기반으로 한 CRUD API와 인증/검색 기능을 제공합니다.

## 핵심 설계 원칙

- **RESTful 설계**: HTTP 메서드와 상태코드의 적절한 사용
- **일관된 응답 형식**: 표준화된 JSON 응답 구조
- **적절한 HTTP 상태코드**: 의미론적으로 올바른 상태코드 사용
- **페이지네이션**: 대용량 데이터에 대한 효율적 처리
- **에러 처리**: 구조화된 에러 응답
- **인증/권한**: JWT 기반 인증과 리소스별 권한 제어

## 🔗 API 베이스 URL

```
개발: http://localhost:3000/api
프로덕션: https://portfolio-manager.example.com/api
```

## 📋 공통 응답 형식

### 성공 응답
```typescript
interface SuccessResponse<T> {
  success: true;
  data: T;
  message?: string;
  meta?: {
    total?: number;
    page?: number;
    pageSize?: number;
    totalPages?: number;
  };
}
```

### 에러 응답
```typescript
interface ErrorResponse {
  success: false;
  error: {
    code: string;
    message: string;
    details?: any;
  };
  timestamp: string;
  path: string;
}
```

### HTTP 상태코드 정책
- `200`: 성공적인 조회/수정
- `201`: 성공적인 생성
- `204`: 성공적인 삭제 (응답 본문 없음)
- `400`: 잘못된 요청 (유효성 검사 실패)
- `401`: 인증 실패
- `403`: 권한 없음
- `404`: 리소스 없음
- `409`: 충돌 (중복 등)
- `422`: 처리할 수 없는 엔티티 (비즈니스 로직 오류)
- `500`: 서버 내부 오류

## 🔐 인증 API

### 1. 소셜 로그인 (OAuth)
```http
POST /api/auth/login/{provider}
```
**Parameters:**
- `provider`: github | google | linkedin

**Request:**
```json
{
  "code": "oauth_authorization_code",
  "state": "random_state_value"
}
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "uuid",
      "email": "user@example.com",
      "name": "User Name",
      "avatar_url": "https://...",
      "role": "user"
    },
    "token": "jwt_token",
    "expires_at": "2024-12-31T23:59:59Z"
  }
}
```

### 2. 로그아웃
```http
POST /api/auth/logout
Authorization: Bearer {token}
```

**Response (204):** No Content

### 3. 토큰 갱신
```http
POST /api/auth/refresh
Authorization: Bearer {token}
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "token": "new_jwt_token",
    "expires_at": "2024-12-31T23:59:59Z"
  }
}
```

### 4. 현재 사용자 정보
```http
GET /api/auth/me
Authorization: Bearer {token}
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "email": "user@example.com",
    "name": "User Name",
    "avatar_url": "https://...",
    "bio": "User bio",
    "website_url": "https://...",
    "github_username": "username",
    "linkedin_url": "https://...",
    "role": "user",
    "is_verified": true,
    "created_at": "2024-01-01T00:00:00Z"
  }
}
```

## 👤 사용자 API

### 1. 사용자 목록 조회 (Admin Only)
```http
GET /api/users?page=1&pageSize=20&search=keyword
Authorization: Bearer {admin_token}
```

**Query Parameters:**
- `page`: 페이지 번호 (기본값: 1)
- `pageSize`: 페이지 크기 (기본값: 20, 최대값: 100)
- `search`: 검색 키워드 (이름, 이메일)

### 2. 사용자 상세 조회
```http
GET /api/users/{userId}
Authorization: Bearer {token}
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "name": "User Name",
    "avatar_url": "https://...",
    "bio": "User bio",
    "website_url": "https://...",
    "github_username": "username",
    "linkedin_url": "https://...",
    "created_at": "2024-01-01T00:00:00Z",
    "project_count": 5,
    "public_project_count": 3
  }
}
```

### 3. 사용자 정보 수정
```http
PATCH /api/users/{userId}
Authorization: Bearer {token}
```

**Request:**
```json
{
  "name": "Updated Name",
  "bio": "Updated bio",
  "website_url": "https://newsite.com",
  "github_username": "newusername",
  "linkedin_url": "https://linkedin.com/in/newusername"
}
```

**Validation Rules:**
- `name`: 필수, 1-100자
- `bio`: 선택, 최대 500자
- `website_url`: 선택, 유효한 URL
- `github_username`: 선택, 1-100자, GitHub username 형식
- `linkedin_url`: 선택, 유효한 LinkedIn URL

## 📁 프로젝트 API

### 1. 프로젝트 목록 조회
```http
GET /api/projects?page=1&pageSize=20&owner={userId}&visibility=public&status=active&search=keyword&tech_stack=react,typescript&featured=true
```

**Query Parameters:**
- `page`: 페이지 번호 (기본값: 1)
- `pageSize`: 페이지 크기 (기본값: 20, 최대값: 100)
- `owner`: 소유자 ID (본인 프로젝트 조회 시)
- `visibility`: public | private | unlisted
- `status`: draft | active | archived
- `search`: 제목, 설명에서 검색
- `tech_stack`: 기술 스택 필터 (쉼표 구분)
- `featured`: true (대표 프로젝트만)
- `sort`: created_at | updated_at | view_count | like_count (기본값: created_at)
- `order`: asc | desc (기본값: desc)

**Response (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": "uuid",
      "slug": "my-awesome-project",
      "title": "My Awesome Project",
      "description": "Project description",
      "tech_stack": ["React", "TypeScript", "Next.js"],
      "categories": ["Web", "Frontend"],
      "tags": ["opensource", "personal"],
      "status": "active",
      "visibility": "public",
      "featured": true,
      "view_count": 150,
      "like_count": 25,
      "created_at": "2024-01-01T00:00:00Z",
      "updated_at": "2024-01-15T00:00:00Z",
      "published_at": "2024-01-02T00:00:00Z",
      "owner": {
        "id": "uuid",
        "name": "Owner Name",
        "avatar_url": "https://..."
      },
      "github_repository": {
        "github_url": "https://github.com/user/repo",
        "stars": 10,
        "forks": 3,
        "language": "TypeScript"
      }
    }
  ],
  "meta": {
    "total": 50,
    "page": 1,
    "pageSize": 20,
    "totalPages": 3
  }
}
```

### 2. 프로젝트 상세 조회
```http
GET /api/projects/{projectId}
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "slug": "my-awesome-project",
    "title": "My Awesome Project",
    "description": "Detailed project description",
    "content": {
      "markdown": "# Project Content\n...",
      "sections": [
        {
          "type": "overview",
          "title": "Overview",
          "content": "..."
        }
      ]
    },
    "tech_stack": ["React", "TypeScript", "Next.js"],
    "categories": ["Web", "Frontend"],
    "tags": ["opensource", "personal"],
    "status": "active",
    "visibility": "public",
    "featured": true,
    "view_count": 150,
    "like_count": 25,
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-15T00:00:00Z",
    "published_at": "2024-01-02T00:00:00Z",
    "owner": {
      "id": "uuid",
      "name": "Owner Name",
      "avatar_url": "https://...",
      "bio": "Owner bio"
    },
    "github_repository": {
      "id": "uuid",
      "github_url": "https://github.com/user/repo",
      "repository_name": "user/repo",
      "stars": 10,
      "forks": 3,
      "watchers": 5,
      "language": "TypeScript",
      "license": "MIT",
      "is_private": false,
      "last_commit_date": "2024-01-15T00:00:00Z",
      "last_synced_at": "2024-01-15T01:00:00Z"
    },
    "media": [
      {
        "id": "uuid",
        "type": "image",
        "file_name": "screenshot.png",
        "file_path": "/uploads/projects/uuid/screenshot.png",
        "width": 1920,
        "height": 1080,
        "alt_text": "Project screenshot"
      }
    ],
    "note_count": 15,
    "note_summary": {
      "learn": 8,
      "change": 5,
      "research": 2
    }
  }
}
```

### 3. 프로젝트 생성
```http
POST /api/projects
Authorization: Bearer {token}
```

**Request:**
```json
{
  "title": "New Project",
  "description": "Project description",
  "slug": "new-project",
  "content": {
    "markdown": "# Project Content\n...",
    "sections": []
  },
  "tech_stack": ["React", "TypeScript"],
  "categories": ["Web"],
  "tags": ["personal"],
  "visibility": "private",
  "github_url": "https://github.com/user/repo"
}
```

**Validation Rules:**
- `title`: 필수, 1-200자
- `description`: 선택, 최대 1000자
- `slug`: 필수, 1-100자, URL-safe 문자만, 소유자 내 유일
- `content`: 선택, JSONB 형식
- `tech_stack`: 선택, 배열, 각 항목 1-50자
- `categories`: 선택, 배열, 각 항목 1-50자  
- `tags`: 선택, 배열, 각 항목 1-30자
- `visibility`: public | private | unlisted (기본값: private)
- `github_url`: 선택, 유효한 GitHub URL

### 4. 프로젝트 수정
```http
PATCH /api/projects/{projectId}
Authorization: Bearer {token}
```

**권한**: 소유자만

### 5. 프로젝트 삭제
```http
DELETE /api/projects/{projectId}
Authorization: Bearer {token}
```

**권한**: 소유자만
**Response (204):** No Content

### 6. 프로젝트 상태 변경
```http
PATCH /api/projects/{projectId}/status
Authorization: Bearer {token}
```

**Request:**
```json
{
  "status": "active"
}
```

**Available Status Transitions:**
- `draft` → `active` (발행)
- `active` → `archived` (보관)
- `archived` → `active` (복구)
- `*` → `deleted` (삭제)

### 7. 프로젝트 조회수 증가
```http
POST /api/projects/{projectId}/views
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "view_count": 151
  }
}
```

## 🗒️ 노트 API

### 1. 노트 목록 조회
```http
GET /api/projects/{projectId}/notes?type=learn&page=1&pageSize=20&search=keyword&pinned=true&archived=false
Authorization: Bearer {token}
```

**Query Parameters:**
- `type`: learn | change | research
- `page`: 페이지 번호 (기본값: 1)
- `pageSize`: 페이지 크기 (기본값: 20, 최대값: 100)
- `search`: 제목, 내용에서 검색
- `pinned`: true | false (고정된 노트만)
- `archived`: true | false (보관된 노트 포함)
- `tags`: 쉼표로 구분된 태그 필터

**권한**: 프로젝트 소유자만

### 2. 노트 상세 조회
```http
GET /api/notes/{noteId}
Authorization: Bearer {token}
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "project_id": "uuid",
    "type": "learn",
    "title": "Learning Note Title",
    "content": {
      "markdown": "# Note Content\n...",
      "blocks": [
        {
          "type": "text",
          "content": "Note content..."
        }
      ]
    },
    "tags": ["javascript", "react"],
    "is_pinned": false,
    "is_archived": false,
    "created_at": "2024-01-01T00:00:00Z",
    "updated_at": "2024-01-15T00:00:00Z",
    "project": {
      "id": "uuid",
      "title": "Project Title",
      "slug": "project-slug"
    },
    "media": [
      {
        "id": "uuid",
        "type": "image",
        "file_name": "diagram.png",
        "file_path": "/uploads/notes/uuid/diagram.png"
      }
    ]
  }
}
```

### 3. 노트 생성
```http
POST /api/projects/{projectId}/notes
Authorization: Bearer {token}
```

**Request:**
```json
{
  "type": "learn",
  "title": "New Learning Note",
  "content": {
    "markdown": "# Note Content\n...",
    "blocks": []
  },
  "tags": ["javascript", "react"],
  "is_pinned": false
}
```

**Validation Rules:**
- `type`: 필수, learn | change | research
- `title`: 필수, 1-200자
- `content`: 필수, JSONB 형식
- `tags`: 선택, 배열, 각 항목 1-30자
- `is_pinned`: 선택, boolean (기본값: false)

### 4. 노트 수정
```http
PATCH /api/notes/{noteId}
Authorization: Bearer {token}
```

### 5. 노트 삭제
```http
DELETE /api/notes/{noteId}
Authorization: Bearer {token}
```

### 6. 노트 핀/언핀
```http
PATCH /api/notes/{noteId}/pin
Authorization: Bearer {token}
```

**Request:**
```json
{
  "is_pinned": true
}
```

### 7. 노트 보관/복구
```http
PATCH /api/notes/{noteId}/archive
Authorization: Bearer {token}
```

**Request:**
```json
{
  "is_archived": true
}
```

## 📸 미디어 API

### 1. 미디어 업로드
```http
POST /api/media/upload
Authorization: Bearer {token}
Content-Type: multipart/form-data
```

**Request:**
```
file: [파일]
target_type: project | note
target_id: uuid
alt_text: "Alternative text"
```

**File Validation:**
- **지원 형식**: jpg, jpeg, png, gif, webp, mp4, mov, pdf, zip
- **최대 크기**: 10MB (이미지), 50MB (비디오), 25MB (문서)
- **보안 검사**: 파일 시그니처 검증, 악성 파일 스캔

**Response (201):**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "target_type": "project",
    "target_id": "uuid",
    "original_name": "screenshot.png",
    "file_name": "uuid_screenshot.png",
    "file_path": "/uploads/projects/uuid/screenshot.png",
    "file_size": 1024000,
    "mime_type": "image/png",
    "type": "image",
    "width": 1920,
    "height": 1080,
    "is_public": false,
    "alt_text": "Project screenshot",
    "created_at": "2024-01-01T00:00:00Z"
  }
}
```

### 2. 미디어 목록 조회
```http
GET /api/media?target_type=project&target_id=uuid&type=image&page=1&pageSize=20
Authorization: Bearer {token}
```

### 3. 미디어 정보 수정
```http
PATCH /api/media/{mediaId}
Authorization: Bearer {token}
```

**Request:**
```json
{
  "alt_text": "Updated alternative text",
  "is_public": true
}
```

### 4. 미디어 삭제
```http
DELETE /api/media/{mediaId}
Authorization: Bearer {token}
```

**Response (204):** No Content

### 5. 미디어 파일 접근
```http
GET /api/media/{mediaId}/file
```

**공개 미디어**: 인증 없이 접근 가능
**비공개 미디어**: 소유자 인증 필요

**Response**: 파일 스트림 또는 Redirect to CDN URL

## 🔍 검색 API

### 1. 전역 검색
```http
GET /api/search?q=keyword&type=all&page=1&pageSize=20&user_id=uuid
```

**Query Parameters:**
- `q`: 검색 키워드 (필수, 최소 2자)
- `type`: all | projects | notes | users (기본값: all)
- `page`: 페이지 번호 (기본값: 1)
- `pageSize`: 페이지 크기 (기본값: 20, 최대값: 50)
- `user_id`: 특정 사용자의 콘텐츠만 검색

**Response (200):**
```json
{
  "success": true,
  "data": {
    "projects": [
      {
        "id": "uuid",
        "title": "Project Title",
        "description": "Project description...",
        "highlight": {
          "title": "Project <mark>Title</mark>",
          "description": "Project <mark>description</mark>..."
        },
        "type": "project",
        "owner": {
          "name": "Owner Name",
          "avatar_url": "https://..."
        }
      }
    ],
    "notes": [
      {
        "id": "uuid",
        "title": "Note Title",
        "content_preview": "Note content preview...",
        "highlight": {
          "title": "Note <mark>Title</mark>",
          "content": "Note content <mark>preview</mark>..."
        },
        "type": "note",
        "note_type": "learn",
        "project": {
          "title": "Project Title",
          "slug": "project-slug"
        }
      }
    ],
    "users": [
      {
        "id": "uuid",
        "name": "User Name",
        "bio": "User bio...",
        "highlight": {
          "name": "User <mark>Name</mark>",
          "bio": "User <mark>bio</mark>..."
        },
        "type": "user",
        "project_count": 5
      }
    ]
  },
  "meta": {
    "total": 45,
    "page": 1,
    "pageSize": 20,
    "totalPages": 3,
    "search_time": "0.045s"
  }
}
```

### 2. 자동완성 검색
```http
GET /api/search/autocomplete?q=keyword&limit=10
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "suggestions": [
      {
        "text": "React Hook",
        "type": "project",
        "count": 3
      },
      {
        "text": "React Router",
        "type": "note",
        "count": 7
      }
    ]
  }
}
```

### 3. 인기 검색어
```http
GET /api/search/trending?limit=10&period=week
```

**Query Parameters:**
- `limit`: 결과 수 (기본값: 10, 최대값: 20)
- `period`: day | week | month (기본값: week)

## 🐙 GitHub 저장소 API

### 1. GitHub 저장소 연동
```http
POST /api/projects/{projectId}/github
Authorization: Bearer {token}
```

**Request:**
```json
{
  "github_url": "https://github.com/user/repo"
}
```

**Response (201):**
```json
{
  "success": true,
  "data": {
    "id": "uuid",
    "project_id": "uuid",
    "github_url": "https://github.com/user/repo",
    "repository_name": "user/repo",
    "stars": 10,
    "forks": 3,
    "watchers": 5,
    "language": "TypeScript",
    "license": "MIT",
    "is_private": false,
    "last_commit_date": "2024-01-15T00:00:00Z",
    "last_synced_at": "2024-01-15T01:00:00Z",
    "is_sync_enabled": true
  }
}
```

### 2. GitHub 정보 동기화
```http
POST /api/github/{githubRepoId}/sync
Authorization: Bearer {token}
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "synced_at": "2024-01-15T01:00:00Z",
    "changes": {
      "stars": 11,
      "forks": 3,
      "last_commit_date": "2024-01-15T00:00:00Z"
    }
  }
}
```

### 3. GitHub 저장소 연동 해제
```http
DELETE /api/github/{githubRepoId}
Authorization: Bearer {token}
```

## 🚦 API 상태 및 헬스체크

### 1. API 상태 확인
```http
GET /api/health
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "status": "healthy",
    "timestamp": "2024-01-15T12:00:00Z",
    "version": "1.0.0",
    "uptime": "72h 15m 30s",
    "services": {
      "database": "healthy",
      "redis": "healthy",
      "storage": "healthy"
    }
  }
}
```

### 2. API 정보
```http
GET /api/info
```

**Response (200):**
```json
{
  "success": true,
  "data": {
    "name": "Portfolio Manager API",
    "version": "1.0.0",
    "description": "Portfolio management and note-taking platform",
    "documentation": "https://api-docs.portfolio-manager.com",
    "support": "support@portfolio-manager.com"
  }
}
```

## 📊 에러 처리 세부사항

### 유효성 검사 에러 (400)
```json
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "요청 데이터가 올바르지 않습니다.",
    "details": {
      "title": ["제목은 필수입니다.", "제목은 최대 200자까지 입력 가능합니다."],
      "email": ["올바른 이메일 형식이 아닙니다."]
    }
  },
  "timestamp": "2024-01-15T12:00:00Z",
  "path": "/api/projects"
}
```

### 인증 에러 (401)
```json
{
  "success": false,
  "error": {
    "code": "UNAUTHORIZED",
    "message": "인증이 필요합니다.",
    "details": {
      "reason": "TOKEN_EXPIRED"
    }
  },
  "timestamp": "2024-01-15T12:00:00Z",
  "path": "/api/projects"
}
```

### 권한 에러 (403)
```json
{
  "success": false,
  "error": {
    "code": "FORBIDDEN",
    "message": "해당 리소스에 접근할 권한이 없습니다.",
    "details": {
      "required_role": "owner",
      "current_role": "viewer"
    }
  },
  "timestamp": "2024-01-15T12:00:00Z",
  "path": "/api/projects/uuid"
}
```

### 리소스 없음 (404)
```json
{
  "success": false,
  "error": {
    "code": "NOT_FOUND",
    "message": "요청한 리소스를 찾을 수 없습니다.",
    "details": {
      "resource": "project",
      "id": "uuid"
    }
  },
  "timestamp": "2024-01-15T12:00:00Z",
  "path": "/api/projects/uuid"
}
```

## 🔒 보안 고려사항

### 1. 인증 및 권한
- **JWT 토큰**: 만료 시간 설정 (기본 24시간)
- **Refresh Token**: 장기간 유지 (30일)
- **Rate Limiting**: IP별 요청 제한 (1분에 60회)
- **CORS**: 허용된 도메인만 접근 가능

### 2. 데이터 검증
- **입력 검증**: 모든 사용자 입력 서버 사이드 검증
- **SQL Injection 방지**: 파라미터화된 쿼리 사용
- **XSS 방지**: HTML 출력 시 이스케이프 처리
- **CSRF 방지**: SameSite 쿠키 설정

### 3. 파일 업로드 보안
- **파일 타입 검증**: MIME 타입 + 파일 시그니처 확인
- **파일 크기 제한**: 타입별 적절한 크기 제한
- **악성 파일 스캔**: 업로드 파일 보안 검사
- **안전한 파일명**: UUID 기반 파일명 생성

### 4. API 보안
- **HTTPS 강제**: 모든 API 요청 HTTPS 사용
- **보안 헤더**: HSTS, X-Frame-Options 등 설정
- **로깅**: 모든 API 요청/응답 로그 기록
- **에러 정보 제한**: 프로덕션에서 상세 에러 정보 숨김

## 📈 성능 최적화

### 1. 캐싱 전략
- **공개 프로젝트**: 5분 캐시
- **사용자 정보**: 30분 캐시
- **검색 결과**: 1분 캐시
- **미디어 파일**: CDN + 영구 캐시

### 2. 페이지네이션
- **기본 페이지 크기**: 20개
- **최대 페이지 크기**: 100개
- **Cursor 기반**: 대용량 데이터 효율적 처리

### 3. 데이터베이스 최적화
- **인덱스 활용**: ERD 설계서의 인덱스 전략 적용
- **N+1 쿼리 방지**: JOIN 또는 배치 로딩 사용
- **connection pooling**: 데이터베이스 연결 최적화

## 🚀 향후 확장 계획

### Phase 2 추가 API
- **Site 배포 API**: 서브도메인 관리
- **Deployment API**: 배포 이력 관리
- **Analytics API**: 방문 통계

### Phase 3 추가 API
- **Team API**: 팀 협업 기능
- **Notification API**: 실시간 알림
- **Webhook API**: 외부 서비스 연동

### Phase 4 추가 API
- **AI API**: 컨텐츠 자동 생성
- **Integration API**: 외부 플랫폼 연동
- **GraphQL API**: 유연한 데이터 조회

---

**다음 단계**: Next.js 14 프로젝트 초기 설정 및 API 라우트 구현